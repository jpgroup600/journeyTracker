(function(){const DEFAULT_CONFIG={COOKIE_NAME:"userJourney",API_ENDPOINT:"/api/userVisit",COOKIE_PATH:"/",TRACK_ALL:false,TRACKING_CLASSES:[{"track-portfolio":"portfolio"},{"track-web-portfolio":"web-portfolio"}],DEBUG:false};class UserJourneyTracker{constructor(config={}){this.config={...DEFAULT_CONFIG,...config};this.startTime=Date.now();this.domain=window.location.hostname;this.pageURL=window.location.pathname;this.isInternalNavigation=false;this.lastClickedElement=null;this.journeyData=this.loadJourneyData();this.initializeEventListeners()}loadJourneyData(){const journeyCookie=document.cookie.split("; ").find((row=>row.startsWith(`${this.config.COOKIE_NAME}=`)));if(journeyCookie){try{return JSON.parse(decodeURIComponent(journeyCookie.split("=")[1]))||[]}catch(error){console.error("Error parsing userJourney cookie:",error);return[]}}return[]}saveJourneyData(scrollPercentage=0){if(!Array.isArray(this.journeyData)){this.journeyData=[]}const duration=this.calculateDuration();const existingData=this.findExistingJourneyData();if(existingData){this.updateExistingData(existingData,scrollPercentage,duration)}else{this.addNewJourneyData(scrollPercentage,duration)}this.saveToCookie()}calculateDuration(){return Math.round((Date.now()-this.startTime)/1e3)}findExistingJourneyData(){return this.journeyData.find((journey=>journey.pageURL===this.pageURL&&journey.domain===this.domain))}getClickData(track_all){if(!track_all){const findTrackingElement=element=>{if(!element||element===document.body)return null;const trackingClassObj=this.config.TRACKING_CLASSES.find((classObj=>{const className=Object.keys(classObj)[0];return element.classList.contains(className)}));if(trackingClassObj){return{element:element,trackingClassObj:trackingClassObj}}return findTrackingElement(element.parentElement)};const result=findTrackingElement(event.target);if(result){const{element:element,trackingClassObj:trackingClassObj}=result;const className=Object.keys(trackingClassObj)[0];const actionName=Object.values(trackingClassObj)[0];const clickData={className:className,actionName:actionName,elementText:this.lastClickedElement.textContent?.trim()||""};return clickData}}else{clickData={className:this.lastClickedElement.className,id:this.lastClickedElement.id,elementText:this.lastClickedElement.textContent?.trim()||"",type:this.lastClickedElement.tagName};return clickData}}updateExistingData(existingData,scrollPercentage,duration){existingData.scrollPosition=`${Math.round(scrollPercentage)}%`;existingData.duration=duration}addNewJourneyData(scrollPercentage,duration){this.journeyData.push({domain:this.domain,pageURL:this.pageURL,scrollPosition:`${Math.round(scrollPercentage)}%`,duration:duration})}saveToCookie(){const jsonString=encodeURIComponent(JSON.stringify(this.journeyData));document.cookie=`${this.config.COOKIE_NAME}=${jsonString}; path=${this.config.COOKIE_PATH};`}deleteCookie(){document.cookie=`${this.config.COOKIE_NAME}=; path=${this.config.COOKIE_PATH}; expires=Thu, 01 Jan 1970 00:00:00 UTC;`;console.log("userJourney cookie deleted")}async sendDataToBackend(){try{const response=await fetch(this.config.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jourtneyDaa:this.journeyData})});if(!response.ok){throw new Error("Network response was not ok")}const data=await response.json();if(data.success){console.log("Data saved successfully:",data.message);return data}throw new Error(data.message||"Failed to save data")}catch(error){console.error("Error saving journey data:",error);throw error}}initializeEventListeners(){document.addEventListener("DOMContentLoaded",(()=>this.saveJourneyData(0)));window.addEventListener("scroll",this.handleScroll.bind(this));document.addEventListener("click",this.handleClick.bind(this),true);window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this));window.addEventListener("pagehide",this.handlePageHide.bind(this))}handleScroll(){const scrollPosition=window.scrollY;const totalHeight=document.documentElement.scrollHeight-window.innerHeight;const scrollPercentage=scrollPosition/totalHeight*100;let currentClass=null;if(this.scrollTimeout){clearTimeout(this.scrollTimeout)}this.scrollTimeout=setTimeout((()=>{this.saveJourneyData(scrollPercentage)}),500)}handleClick(event){this.lastClickedElement=event.target;if(event.target.tagName==="A"){this.isInternalNavigation=true}const clickData=this.getClickData(this.config.TRACK_ALL);if(clickData!==null){const lastJourney=this.journeyData[this.journeyData.length-1];if(lastJourney&&!lastJourney.clicks){lastJourney.clicks=[]}lastJourney.clicks.push(clickData);this.saveJourneyData()}}handleBeforeUnload(event){alert("handleBeforeUnload");const scrollPosition=window.scrollY;const totalHeight=document.documentElement.scrollHeight-window.innerHeight;const scrollPercentage=scrollPosition/totalHeight*100;this.saveJourneyData(scrollPercentage);this.sendDataToBackend().catch((error=>{console.error("Failed to send data before unload:",error)}))}handlePageHide(event){if(!this.isInternalNavigation){const scrollPosition=window.scrollY;const totalHeight=document.documentElement.scrollHeight-window.innerHeight;const scrollPercentage=scrollPosition/totalHeight*100;this.saveJourneyData(scrollPercentage);this.sendDataToBackend().catch((error=>{console.error("Failed to send data on page hide:",error)}))}alert("handlePageHide",this.scrollPercentage)}}function initializeTracker(config={}){if(window.userJourneyTracker){console.warn("UserJourneyTracker already initialized");return window.userJourneyTracker}window.userJourneyTracker=new UserJourneyTracker(config);return window.userJourneyTracker}window.UserJourneyTracker={init:initializeTracker,version:"1.0.1"}})(window);